function openChangePassword() { var b = document.getElementById('cpBackdrop'); if (b) b.style.display = 'flex' }
function closeChangePassword() { var b = document.getElementById('cpBackdrop'); if (b) b.style.display = 'none' }
function submitChangePassword() { var o = document.getElementById('cp_old').value.trim(); var n = document.getElementById('cp_new').value.trim(); var c = document.getElementById('cp_confirm').value.trim(); var err = document.getElementById('cp_error'); var ok = document.getElementById('cp_success'); err.style.display = 'none'; ok.style.display = 'none'; if (!o || !n || !c) { err.textContent = 'Please fill in all fields.'; err.style.display = 'block'; return } if (n !== c) { err.textContent = 'New passwords do not match.'; err.style.display = 'block'; return } fetch('/api/change_password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old_password: o, new_password: n, confirm_password: c }) }).then(async r => { var d = await r.json().catch(() => ({})); if (r.ok && d.success) { ok.textContent = 'Password changed successfully.'; ok.style.display = 'block'; document.getElementById('cp_old').value = ''; document.getElementById('cp_new').value = ''; document.getElementById('cp_confirm').value = '' } else { err.textContent = (d && d.error) || 'Failed to change password.'; err.style.display = 'block' } }).catch(() => { err.textContent = 'Network error. Please try again.'; err.style.display = 'block' }) }
document.addEventListener('click', function (e) { var b = document.getElementById('cpBackdrop'); var m = document.getElementById('cpModal'); if (b && m && e.target === b) { closeChangePassword() } });

